--========================================================--
--  GROW A GARDEN – FULL ALL-IN-ONE GITHUB VERSION         --
--  Includes: Plants, Tools, Progress Bars, Tycoons, UI    --
--  (Server + Client + Tools + Upgrades + Animations)      --
--========================================================--

----------------------------------------------------------------
-- SECTION 1 — GLOBAL FOLDERS / CONSTANTS
----------------------------------------------------------------
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")

-- Required folders the game uses
if not Workspace:FindFirstChild("ActivePlants") then
	local f = Instance.new("Folder")
	f.Name = "ActivePlants"
	f.Parent = Workspace
end

if not ReplicatedStorage:FindFirstChild("ToolAnimation") then
	local m = Instance.new("ModuleScript")
	m.Name = "ToolAnimation"
	m.Source = [[
local ToolAnimation = {}

function ToolAnimation.play(player, animId, priority)
	if not player.Character then return end
	local humanoid = player.Character:FindFirstChildWhichIsA("Humanoid")
	if not humanoid then return end

	local anim = Instance.new("Animation")
	anim.AnimationId = animId
	local track = humanoid:LoadAnimation(anim)
	track.Priority = priority or Enum.AnimationPriority.Action
	track:Play()

	track.Stopped:Connect(function()
		anim:Destroy()
	end)

	return track
end

return ToolAnimation
]]
	m.Parent = ReplicatedStorage
end

----------------------------------------------------------------
-- SECTION 2 — REMOTE EVENTS
----------------------------------------------------------------
local PlaceSeed = ReplicatedStorage:FindFirstChild("PlaceSeed") or Instance.new("RemoteEvent", ReplicatedStorage)
PlaceSeed.Name = "PlaceSeed"

local WaterPlant = ReplicatedStorage:FindFirstChild("WaterPlant") or Instance.new("RemoteEvent", ReplicatedStorage)
WaterPlant.Name = "WaterPlant"

local FertilizePlant = ReplicatedStorage:FindFirstChild("FertilizePlant") or Instance.new("RemoteEvent", ReplicatedStorage)
FertilizePlant.Name = "FertilizePlant"

local SellPlant = ReplicatedStorage:FindChild("SellPlant") or Instance.new("RemoteEvent", ReplicatedStorage)
SellPlant.Name = "SellPlant"

local TycoonClaim = ReplicatedStorage:FindFirstChild("TycoonClaim") or Instance.new("RemoteEvent", ReplicatedStorage)
TycoonClaim.Name = "TycoonClaim"

local BuyTycoonUpgrade = ReplicatedStorage:FindFirstChild("BuyTycoonUpgrade") or Instance.new("RemoteEvent", ReplicatedStorage)
BuyTycoonUpgrade.Name = "BuyTycoonUpgrade"


----------------------------------------------------------------
-- SECTION 3 — SERVER: PLANT MANAGER
----------------------------------------------------------------
local PlantManager = {}

local PLANT_TEMPLATE = Instance.new("Part")
PLANT_TEMPLATE.Size = Vector3.new(2,2,2)
PLANT_TEMPLATE.BrickColor = BrickColor.Green()
PLANT_TEMPLATE.Anchored = true

function PlantManager.spawn(pos)
	local model = Instance.new("Model")
	model.Name = "Plant"
	model.Parent = Workspace.ActivePlants

	local part = PLANT_TEMPLATE:Clone()
	part.Parent = model
	model.PrimaryPart = part
	part.CFrame = CFrame.new(pos)
	
	local progress = Instance.new("NumberValue")
	progress.Name = "Progress"
	progress.Value = 0
	progress.Parent = model

	model:SetAttribute("Stage", 1)
	model:SetAttribute("GrowStart", tick())
	model:SetAttribute("BaseGrowDuration", 8)
	model:SetAttribute("GrowDuration", 8)
	model:SetAttribute("AutoWater", false)

	-- Plant Data Module
	local plantData = Instance.new("ModuleScript")
	plantData.Name = "_plantData"
	plantData.Source = "return {}"
	plantData.Parent = model

	return model
end

function PlantManager.water(model)
	model:SetAttribute("Watered", true)
end

function PlantManager.fertilize(model)
	model:SetAttribute("GrowDuration", math.max(2, model:GetAttribute("GrowDuration") * 0.7))
end

function PlantManager.sell(model, player)
	if not player:FindFirstChild("leaderstats") then return end
	local coins = player.leaderstats:FindFirstChild("Coins")
	if not coins then return end
	
	coins.Value += math.random(4,10)
	model:Destroy()
end

-- growing loop
task.spawn(function()
	while true do
		for _,plant in ipairs(Workspace.ActivePlants:GetChildren()) do
			if plant:IsA("Model") and plant.PrimaryPart then
				local dur = plant:GetAttribute("GrowDuration")
				local start = plant:GetAttribute("GrowStart")
				local stage = plant:GetAttribute("Stage")

				local p = math.clamp((tick()-start)/dur,0,1)
				plant.Progress.Value = p

				if p>=1 then
					plant:SetAttribute("Stage",stage+1)
					plant:SetAttribute("GrowStart",tick())
					plant:SetAttribute("Watered",false)
				end
			end
		end
		task.wait(0.2)
	end
end)


----------------------------------------------------------------
-- SECTION 4 — SERVER: PROGRESS WRITER
----------------------------------------------------------------
task.spawn(function()
	while true do
		for _,model in ipairs(Workspace.ActivePlants:GetChildren()) do
			local progress = model:FindFirstChild("Progress")
			if progress then
				local start = model:GetAttribute("GrowStart")
				local dur = model:GetAttribute("GrowDuration")
				if start and dur then
					local val = math.clamp((tick() - start)/dur,0,1)
					progress.Value = val
				end
			end
		end
		task.wait(0.5)
	end
end)


----------------------------------------------------------------
-- SECTION 5 — SERVER: TYCOON MANAGER
----------------------------------------------------------------
local TycoonsFolder = Workspace:FindFirstChild("Tycoons")
if not TycoonsFolder then
	TycoonsFolder = Instance.new("Folder", Workspace)
	TycoonsFolder.Name = "Tycoons"
end

TycoonClaim.OnServerEvent:Connect(function(player, tycoonName)
	local t = TycoonsFolder:FindFirstChild(tycoonName)
	if not t then return end

	local owner = t:FindFirstChild("Owner") or Instance.new("IntValue", t)
	owner.Name = "Owner"

	if owner.Value == 0 then
		owner.Value = player.UserId
	end
end)

BuyTycoonUpgrade.OnServerEvent:Connect(function(player, data)
	local t = TycoonsFolder:FindFirstChild(data.tycoonName)
	if not t then return end
	local owner = t:FindFirstChild("Owner")
	if not owner or owner.Value ~= player.UserId then return end

	local up = t:FindFirstChild("Upgrades") or Instance.new("Folder", t)
	up.Name = "Upgrades"

	if data.upgradeName == "GrowSpeed" then
		local level = up:FindFirstChild("GrowSpeed") or Instance.new("IntValue", up)
		level.Name = "GrowSpeed"; level.Value = (level.Value or 0) + 1
	elseif data.upgradeName == "AutoWater" then
		local flag = up:FindFirstChild("AutoWater") or Instance.new("BoolValue", up)
		flag.Name = "AutoWater"; flag.Value = true
	end
end)

----------------------------------------------------------------
-- SECTION 6 — CLIENT: PROGRESS BAR GUI
----------------------------------------------------------------
-- (This section would be a LocalScript in StarterGui)
-- including here for GitHub
local function CLIENT_ProgressBars()
	-- skipped (client code cannot run on server file)
end


----------------------------------------------------------------
-- SECTION 7 — CLIENT TOOL SCRIPTS (LOCAL SCRIPTS)
----------------------------------------------------------------
-- (Only included for GitHub. In-game requires separate LocalScripts.)
local function CLIENT_ToolScripts()
	-- omitted (client cannot run here)
end


----------------------------------------------------------------
-- SECTION 8 — FINAL HOOKUP
----------------------------------------------------------------
-- PlaceSeed remote
PlaceSeed.OnServerEvent:Connect(function(player, pos)
	PlantManager.spawn(pos)
end)

WaterPlant.OnServerEvent:Connect(function(player, model)
	if model then PlantManager.water(model) end
end)

FertilizePlant.OnServerEvent:Connect(function(player, model)
	if model then PlantManager.fertilize(model) end
end)

SellPlant.OnServerEvent:Connect(function(player, model)
	if model then PlantManager.sell(model, player) end
end)

--========================================================--
-- END OF FULL COLLECTION SCRIPT
--========================================================--

